# Alpha-One Credit Cockpit（信用驾驶舱）

基于Python和Streamlit构建的固定收益投资组合分析系统，专为量化投资组合管理设计。

## 项目概述

Alpha-One Credit Cockpit 专为管理大型固定收益投资组合（500亿美元以上）的投资组合经理设计。系统通过以下功能实现投资工作流程的数字化：

- **贵/便宜债券识别**：支持二次曲线和Nelson-Siegel模型的分层回归分析
- **单券深度分析**：交互式代码检查器，包含发行人曲线可视化
- **净息差效率监控**：追踪收益率与资金成本（FTP）的差异，识别"失血"资产
- **估值滞后风险检测**：突出显示存在潜在估值问题的持仓
- **会计分类感知分析**：正确处理HTM与AFS分类
- **移动端优先设计**：适配所有设备的响应式深色主题

## 系统架构

```
Alpha-One-Credit-Cockpit/
├── app.py                      # Streamlit仪表板（入口点）
├── requirements.txt            # Python依赖
├── data/
│   └── portfolio.csv           # 示例投资组合数据
├── src/
│   ├── __init__.py
│   ├── module_a/               # 发行人360°（未来：AI定性分析）
│   │   ├── __init__.py
│   │   ├── base.py             # LLM集成的抽象基类
│   │   └── issuer_360.py       # 主引擎（占位符）
│   ├── module_b/               # 投资组合优化器（MVP）
│   │   ├── __init__.py
│   │   ├── data_loader.py      # 数据清洗与转换
│   │   └── analytics.py        # 量化分析引擎
│   └── utils/
│       ├── __init__.py
│       └── constants.py        # 配置常量
└── tests/                      # 单元测试
```

### 模块A：发行人360°（未来扩展）

AI驱动的定性分析模块。目前提供：
- 用于未来LLM集成的抽象基类
- 信用分析、文档处理和新闻分析的占位符实现
- 设计用于与OpenAI、Anthropic或其他LLM提供商无缝集成

### 模块B：投资组合优化器（当前MVP）

对当前持仓的量化扫描，包括：
- 双模型曲线拟合（二次曲线 & Nelson-Siegel）
- 通过Z分数识别贵/便宜债券
- 净息差效率分析
- 单券检查器，含发行人分组
- 板块特定的收益率曲线拟合
- 会计分类处理（HTM/AFS）

## 安装说明

```bash
# 克隆仓库
git clone <repository-url>
cd Alpha-One-Credit-Cockpit

# 创建虚拟环境（推荐）
python -m venv venv
source venv/bin/activate  # Windows系统: venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

## 使用方法

### 运行仪表板

```bash
streamlit run app.py
```

仪表板将在浏览器中打开，地址为 `http://localhost:8501`。

### 使用数据加载器

```python
from src.module_b.data_loader import DataLoader

# 加载并清洗投资组合数据
loader = DataLoader()
df = loader.load("path/to/portfolio.csv")

# 检查数据质量
report = loader.get_quality_report()
print(report.to_dict())
```

### 使用分析引擎

```python
from src.module_b.analytics import PortfolioAnalyzer

# 使用清洗后的数据初始化并选择模型
analyzer = PortfolioAnalyzer(df, model_type="nelson_siegel")  # 或 "quadratic"

# 拟合板块曲线
regression_results = analyzer.fit_sector_curves()

# 获取卖出候选（贵的债券）
sell_candidates = analyzer.get_sell_candidates(z_threshold=-1.5)

# 获取失血资产（负息差）
bleeding = analyzer.get_bleeding_assets()

# 生成高管摘要
summary = analyzer.generate_executive_summary()
```

## 数据格式

系统接受包含双语（中英文）列名的CSV文件：

| 源列名 | 目标列名 | 描述 |
|--------|----------|------|
| 分类1 | Sector_L1 | 一级板块（MBS、公司债、金融债等） |
| 分类2 | Sector_L2 | 二级板块（国企、外资银行等） |
| TICKER | Ticker | 债券代码 |
| 债券名称 | Name | 债券名称 |
| AccSection | Accounting | 会计分类（HTM、AFS、公允价值） |
| Nominal（USD） | Nominal_USD | 持仓规模（美元） |
| Duration | Duration | 修正久期 |
| EffectiveYield | Yield | 有效收益率（转换为小数） |
| OAS | OAS | 期权调整利差 |
| FTP Rate | FTP | 资金转移定价 |

### 派生列（自动生成）

| 列名 | 公式 | 描述 |
|------|------|------|
| Liquidity_Proxy | 如果 Nominal > 1000万美元: 5，否则: 3 | 流动性评分 |
| Net_Carry | Yield - FTP | 扣除资金成本后的息差 |
| Carry_Efficiency | Net_Carry / Duration | 单位久期息差 |
| Is_Tradeable | Accounting != 'HTM' | 是否可交易 |

## 量化方法论

### 双曲线模型

系统支持两种收益率曲线模型：

#### 1. 二次曲线模型（多项式回归）

对于每个板块，拟合二次收益率-久期曲线：

$$收益率 = a \cdot 久期^2 + b \cdot 久期 + c$$

**优势：**
- 简单且易于解释
- 计算速度快
- 适用于标准收益率曲线

#### 2. Nelson-Siegel模型（高级参数化模型）

实现Nelson-Siegel参数化模型：

$$Yield(\tau) = \beta_0 + \beta_1 \cdot \frac{1-e^{-\tau/\lambda}}{\tau/\lambda} + \beta_2 \cdot \left(\frac{1-e^{-\tau/\lambda}}{\tau/\lambda} - e^{-\tau/\lambda}\right)$$

**参数说明：**
- **β₀（长期水平）**：久期趋向无穷时的渐近收益率
- **β₁（短期因子）**：原点斜率（短期因子）
- **β₂（曲率因子）**：中期曲率成分
- **λ（衰减参数）**：控制曲率峰值位置

**优势：**
- 基于期限结构理论，理论基础扎实
- 更好地捕捉非线性曲线形状
- 可分别解释短期、中期和长期因子
- 对不规则收益率曲线更稳健

### 分层回归与Z分数

**关键指标：**
- **模型收益率**：从拟合曲线预测的收益率
- **残差**：实际收益率 - 模型收益率
- **Z分数**：残差 / 残差标准差

**解释：**
- Z分数 < -1.5：**贵**（昂贵，卖出候选）
- Z分数 > +1.5：**便宜**（有吸引力，买入候选）
- -0.5 < Z分数 < +0.5：**公允价值**

### 会计约束

- **HTM（持有至到期）**：由于监管要求不能出售。从优化建议中排除。
- **AFS（可供出售）**：可以自由交易。
- **公允价值**：按市值计价，可交易。

## 仪表板功能

### 标签页1：矩阵视图（相对价值）
- 久期与收益率的交互式散点图
- 板块特定回归曲线叠加（二次曲线或Nelson-Siegel）
- 模型参数显示面板
- 选中代码以金星标记高亮显示
- **🔍 单券分析**：
  - 任意债券代码下拉选择器
  - 当前指标展示（YTM、OAS、Z分数）
  - 情景分析表格（实际收益率 vs 公允收益率）
  - 自动化交易建议
  - 发行人曲线可视化，显示同一发行人的所有债券
- 悬停显示双语债券详细信息

### 标签页2：优化实验室
- 卖出候选表格（Z分数 < -1.5）
- 失血资产表格（净息差 < 0）
- 息差效率分布
- 持仓敞口汇总

### 标签页3：发行人360°仪表板
- **发行人选择**：下拉菜单选择组合中的任意发行人，并显示快速统计
- **A部分 - 估值曲线**：
  - 发行人债券散点图（金色钻石标记）叠加在板块曲线上
  - 发行人特定曲线插值（如有3个以上债券）
  - 板块基准曲线（Nelson-Siegel）用于对比
  - 可视化洞察：识别发行人相对板块是偏贵（Wide/Rich）还是偏便宜（Tight/Cheap）
- **B部分 - 财务仪表板**：
  - 2x2网格显示季度趋势图（8个季度）
  - 去杠杆：柱状图（总负债）+ 折线图（净杠杆）
  - 流动性：堆叠面积图（现金 vs. 净利息支出）
  - 盈利能力：折线图（EBITDA利润率）
  - 增长：柱状图（收入环比增长）
- **C部分 - 信用同业对比**：
  - 雷达图对比发行人与板块平均水平
  - 指标：净杠杆（倒数）、利息覆盖率、EBITDA利润率、现金比率、收入增长
  - 自动化洞察和同业统计
  - 雷达图失败时降级为并排柱状图

### 标签页4：管理简报
- 一键生成高管摘要
- 投资组合指标概览
- 板块配置可视化
- 数据导出功能（完整组合、卖出清单、回归统计）

### 特色功能
- **📱 移动端优先设计**：适配所有屏幕尺寸的响应式布局
- **🌓 深色主题**：专业的Bloomberg/Aladdin风格机构级UI
- **🌐 双语界面**：所有标签均含中英文（English/中文）
- **🔬 模型选择**：在二次曲线和Nelson-Siegel模型之间切换
- **⭐ 代码高亮**：选中的债券在主图表上以金星显示
- **🏢 发行人分组**：自动检测和可视化同一发行人的债券

## 未来开发

### 模块A集成
`src/module_a/base.py` 中的抽象基类设计用于：
- **BaseCreditProfiler**：LLM驱动的信用档案生成
- **BaseDocumentProcessor**：SEC文件和契约文档分析
- **BaseNewsAnalyzer**：新闻情绪和重大事件检测

集成LLM提供商的方法：

```python
from src.module_a.base import BaseCreditProfiler
from src.module_a.issuer_360 import Issuer360Engine

# 实现您的自定义分析器
class OpenAICreditProfiler(BaseCreditProfiler):
    def generate_profile(self, issuer_id, ...):
        # 您的LLM实现
        pass

# 注册到引擎
engine = Issuer360Engine()
engine.register_credit_profiler(OpenAICreditProfiler())
```

## 贡献指南

1. Fork本仓库
2. 创建功能分支
3. 为新功能编写测试
4. 提交Pull Request

## 许可证

MIT许可证

## 联系方式

如有问题或需要支持，请在仓库中提交Issue。

---

## 开发日志

### 2026-01-22（第二阶段：高级建模与交互性）

**Nelson-Siegel模型实现**
- 添加Nelson-Siegel参数化收益率曲线模型作为二次回归的替代
- 实现 `nelson_siegel()` 函数，包含β₀、β₁、β₂、λ参数
- 添加 `NelsonSiegelResult` 数据类用于存储拟合参数
- 使用 `scipy.optimize.curve_fit` 进行参数校准，设置合适的边界
- UI中添加模型选择切换（二次曲线 vs Nelson-Siegel）
- 在统计面板中显示模型特定参数

**单券分析**
- 交互式代码下拉选择器（按字母顺序排序）
- 选中的代码在主散点图上以金星⭐高亮显示
- 当前指标卡片：YTM、OAS、Z分数，带颜色编码
- 情景分析表格：实际收益率、公允收益率、残差、Z分数
- 自动化解释：贵/便宜/公允，带买入/卖出/持有建议
- 智能发行人检测和分组

**发行人曲线可视化**
- 自动检测同一发行人的债券
- 迷你图表显示发行人特定收益率曲线
- 叠加板块曲线作为参考
- 金星高亮显示选中债券
- 显示找到的同类债券数量

**技术改进**
- 添加 `importlib.reload()` 强制加载最新模块版本，防止缓存问题
- 创建完整的 `.gitignore` 文件排除Python缓存文件
- 为小数据集的曲线拟合添加健壮的错误处理
- 统一两种模型类型的Z分数计算
- 保持与二次曲线模型的向后兼容性

**提交记录：**
- `34304da` - 修复模块重载问题：添加importlib.reload()强制加载最新模块版本
- `8e65ffd` - 添加.gitignore以排除Python缓存文件和临时文件
- `c6c0783` - 实现Nelson-Siegel模型和单券深度分析

### 2026-01-22（第1.5阶段：UI/UX增强）

**移动端优先重设计**
- Bloomberg/Aladdin风格深色主题的完整UI改造
- 针对移动设备优化的响应式设计
- 自定义CSS，包含玻璃拟态效果和流畅动画
- 可折叠筛选器，具有移动端友好的触摸目标

**双语界面**
- 完整的中英文双语支持
- 所有标签、工具提示和帮助文本均为双语
- 中文板块名称翻译
- 双语指标卡片和数据表格

**视觉改进**
- 专业配色方案（深蓝、紫色、绿色）
- 平滑渐变背景
- 自定义滚动条匹配主题
- 悬停效果和过渡动画
- 带强调边框的指标卡片
- 移动端视图的债券卡片

**Bug修复**
- 通过用辅助函数替换字典解包修复Plotly布局类型错误
- 改进缺失数据的错误处理

**提交记录：**
- `c45e8f1` - 通过用辅助函数替换字典解包修复Plotly布局类型错误
- `605b114` - 升级为机构级移动端优先双语仪表板

### 2026-01-21（第一阶段：MVP发布）

**核心系统实现**
- 模块化结构的完整架构设置
- 双语CSV解析的数据加载器
- 收益率曲线拟合的二次回归
- 基于Z分数的贵/便宜债券识别
- 净息差效率分析

**分析引擎**
- 带分层回归的 `PortfolioAnalyzer` 类
- 自动板块曲线拟合
- 卖出候选识别（Z < -1.5）
- 失血资产检测（净息差 < 0）
- 投资组合指标聚合
- 高管摘要生成

**仪表板功能**
- 三标签页界面：矩阵视图/优化实验室/管理简报
- 交互式久期-收益率散点图
- 板块特定回归曲线叠加
- 息差分布直方图
- 板块配置饼图
- CSV数据导出功能

**数据处理**
- 带列映射的健壮CSV解析
- 数据验证和质量报告
- 派生指标计算（净息差、息差效率）
- 流动性代理评分
- 会计分类处理

**技术基础**
- 用于未来LLM集成的抽象基类（模块A）
- 单元测试框架
- 类型提示和文档
- 常量管理
- 错误处理和日志记录

**提交记录：**
- `92fe061` - 实现Alpha-One Credit Cockpit固定收益投资组合系统
- `bac31be` - 合并Pull Request #1
- `dff66b9` - 初始仓库设置

### 2026-01-23（第三阶段：基本面整合与UI优化）

**财务基本面模块**
- 创建 `src/module_b/financials.py` 处理季度财务数据
- 实现 `FinancialDataLoader` 类，自动债券-股票代码映射
- 添加 `QuarterlyMetrics` 和 `IssuerFundamentals` 数据类实现结构化数据
- 指标计算：净债务代理、净杠杆、利息覆盖率、收入环比增长
- 优雅处理缺失的EBITDA/利息支出（填充0或排除）
- 8个季度历史数据缓存用于趋势分析

**Bloomberg终端美学**
- 更新CSS配色方案：深黑色(#121212)、彭博橙(#FF9800)、终端蓝(#00B0FF)
- 财务指标使用等宽字体(Roboto Mono)
- 带橙色强调边框的增强指标卡片
- 专业玻璃拟态效果，带背景模糊
- 基本面面板和KPI卡片的自定义样式

**语言切换**
- 在页眉添加双语切换按钮(🌐 EN/CN)
- 语言偏好的会话状态管理
- 带悬停效果和活动状态样式的按钮
- 通过页面重新运行实现无缝语言切换

**信用分析面板**
- 在主页面(标签页1)直接集成基本面显示
- 双栏布局：左侧(定价分析)，右侧(财务基本面)
- 左栏显示公允价值和Z分数估值指标
- 右栏显示：
  - 发行人信息(股票代码和名称)
  - 三个KPI卡片：收入环比增长、净杠杆、利息覆盖率
  - 8季度净杠杆趋势图(面积图，极简设计)
- 颜色编码指标：绿色(安全)、黄色(中等)、红色(风险)
- 通过 `bond_equity_map.csv` 和 `quarterly_financials.csv` 自动映射

**数据架构**
- 加载 `bond_equity_map.csv`(131个发行人)，实现债券代码→股票代码映射
- 加载 `quarterly_financials.csv`，包含历史季度数据
- 应用启动时自动加载数据，带覆盖率统计
- 特定债券无基本面数据时优雅降级

**技术改进**
- 为 `financials.py` 添加模块重载以防止缓存问题
- 财务数据加载器的会话状态管理
- 通过债券代码实现O(1)查找的发行人基本面高效缓存
- 对缺失或不完整基本面数据的健壮错误处理
- 按日期升序自动排序季度数据

**用户体验**
- 选择代码后，信用分析面板出现在单券分析下方
- 趋势图采用简洁设计，无网格线(Bloomberg风格)
- 悬停工具提示显示季度和精确杠杆值
- 发行人股票代码以橙色高亮显示
- 与现有定价分析无缝集成

**提交记录：**
- 待定 - 第三阶段：集成财务基本面与信用分析面板

### 2026-01-23（第3.5阶段：发行人360°仪表板）

**综合发行人深度分析**
- 创建新的标签页3"Issuer 360 / 发行人全景"专门用于单一发行人分析
- 将管理简报移至标签页4以容纳新仪表板
- 发行人下拉选择器，带实时快速统计（债券数量、总敞口）
- 动态筛选，仅显示当前组合中有债券的发行人

**A部分：估值曲线（发行人 vs. 板块）**
- 散点图，发行人债券以金色钻石标记显示
- 发行人特定收益率曲线插值（线性，适用于3个以上债券）
- 叠加板块基准曲线（Nelson-Siegel）用于对比
- 可视化洞察面板：识别发行人相对板块交易偏贵/偏便宜
- 计算所有发行人债券的平均Z分数，带颜色编码信号
- 快速指标：加权久期、加权YTM、债券数量

**B部分：财务仪表板（2x2网格）**
- 使用最近8个季度的财务数据进行季度趋势分析
- 图表1 - 去杠杆：双轴图，总负债（柱状图，左轴）+ 净杠杆（折线图，右轴）
- 图表2 - 流动性：堆叠面积图显示现金 vs. 净利息支出
- 图表3 - 盈利能力：带填充的折线图显示EBITDA利润率趋势
- 图表4 - 增长：颜色编码柱状图（绿色/红色）显示收入环比增长
- 所有图表采用Bloomberg风格极简设计和深色主题

**C部分：信用同业对比**
- 基于发行人板块自动识别同业组
- 计算最新季度板块平均值，覆盖5个关键指标
- 雷达图（蜘蛛图）对比发行人与板块平均值：
  - 净杠杆（倒数，便于视觉解读）
  - 利息覆盖率
  - EBITDA利润率
  - 现金比率
  - 收入增长
- 雷达图失败时降级为并排对比表格
- 自动化洞察生成：识别相对同业的优势/劣势
- 同业统计面板：板块名称、同业数量、关键结论

**技术实现**
- 与 `FinancialDataLoader` 集成获取季度指标
- 高效使用应用启动时构建的发行人基本面缓存
- 对缺失财务数据的健壮错误处理
- 同业数据不可用时优雅降级
- 使用 `scipy.interpolate.interp1d` 进行发行人曲线拟合
- 使用指标比较的条件逻辑进行颜色编码洞察
- 全程响应式2栏布局，适配桌面/移动端

**用户体验**
- 三个不同部分的清晰视觉层次
- 全文双语（英文/中文）
- 所有交互元素的工具提示和悬停状态
- 发行人无债券或数据时的空状态消息
- 与现有组合筛选器无缝集成
- 保持专业的Bloomberg风格深色主题

**提交记录：**
- 待定 - 第3.5阶段：实现发行人360°综合仪表板

---

**总开发时间**：4天
**当前版本**：3.5（第3.5阶段）
**代码行数**：约5,500行
**测试覆盖率**：进行中

---

## 术语对照表

| 英文术语 | 中文翻译 | 说明 |
|----------|----------|------|
| Rich | 贵 | 相对于曲线偏贵的债券 |
| Cheap | 便宜 | 相对于曲线偏便宜的债券 |
| Net Carry | 净息差 | 收益率减去资金成本 |
| Carry Efficiency | 息差效率 | 单位久期产生的净息差 |
| Bleeding Assets | 失血资产 | 净息差为负的资产 |
| Z-Score | Z分数 | 标准化残差 |
| HTM | 持有至到期 | Hold-to-Maturity的缩写 |
| AFS | 可供出售 | Available-for-Sale的缩写 |
| FTP | 资金转移定价 | Funds Transfer Pricing的缩写 |
| OAS | 期权调整利差 | Option-Adjusted Spread的缩写 |
| Duration | 久期 | 债券价格对利率变化的敏感度 |
| Sector | 板块 | 债券分类 |
| Regression | 回归 | 统计建模方法 |
| Residual | 残差 | 实际值与预测值的差异 |
| Nelson-Siegel | Nelson-Siegel模型 | 收益率曲线参数化模型 |
| Quadratic | 二次曲线 | 多项式回归模型 |
| Beta (β) | 贝塔系数 | Nelson-Siegel模型参数 |
| Lambda (λ) | 兰姆达 | 衰减参数 |
| Issuer | 发行人 | 债券发行机构 |
| Ticker | 代码 | 债券交易代码 |
| Fair Value | 公允价值 | 模型估计的合理价格 |
| Drill-Down | 深度分析 | 单个证券的详细分析 |
